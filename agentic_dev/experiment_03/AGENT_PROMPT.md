# Agent Prompt: Build XPR MCP Server (Experiment 03)

## ğŸ¯ Mission
Build a minimal viable Azure Functions MCP server that exposes 3 Proton blockchain tools using FastMCP Python + Proton CLI Node.js subprocess execution. Deploy to Azure 'sama' resource group for fast iteration.

## ğŸ“‹ Critical Context

### What You're Building
- **Input**: Working experiment_02 (weather MCP) + Proton CLI tools from experiment_01
- **Output**: Azure Functions MCP server with 3 blockchain query tools
- **Strategy**: Copy experiment_02, modify minimally, document everything
- **Tools**: `get_account`, `get_chain_info`, `get_block` (only these 3 for MVP)

### Why This Approach
- âœ… Experiment_02 is deployed and working
- âœ… Minimal scope reduces risk (3 tools vs 32)
- âœ… Same infrastructure = fast redeployment via `azd up`
- âœ… Incremental changes = easier debugging
- âš ï¸ Auth configuration previously caused issues - track carefully

## ğŸ“ Key File Paths

### Your Working Directory
```
/workspaces/XPR/agentic_dev/experiment_03/
```

### Essential Documentation (READ THESE FIRST)
```
/workspaces/XPR/agentic_dev/experiment_03/agent.md                    # Master architectural vision
/workspaces/XPR/agentic_dev/experiment_03/CHANGES.md                  # Change tracking log
/workspaces/XPR/agentic_dev/experiment_03/AGENT_PROMPT.md            # This file
```

### Source Code to Copy (Experiment 02 - Working Baseline)
```
/workspaces/XPR/agentic_dev/experiment_02/mcp-sdk-functions-hosting-python/
â”œâ”€â”€ server.py                           # Main FastMCP server (has weather tools)
â”œâ”€â”€ host.json                           # Azure Functions runtime config
â”œâ”€â”€ local.settings.json                 # Local environment variables
â”œâ”€â”€ requirements.txt                    # Python dependencies
â”œâ”€â”€ .funcignore                         # Files to ignore during deployment
â”œâ”€â”€ infra/                              # Bicep infrastructure as code
â”‚   â”œâ”€â”€ main.bicep                      # Main infrastructure definition
â”‚   â”œâ”€â”€ main.parameters.json            # Parameters for deployment
â”‚   â””â”€â”€ resources.bicep                 # Resource definitions
â””â”€â”€ azure.yaml                          # Azure Developer CLI config

Deployed URL: https://YOUR-FUNCTION-APP.azurewebsites.net/mcp
Local URL: http://localhost:7071/mcp
```

### Reference Implementation (Experiment 01 - Tool Patterns)
```
/workspaces/XPR/agentic_dev/experiment_01/src/tools/
â”œâ”€â”€ account/
â”‚   â”œâ”€â”€ get-account.ts                  # Pattern for get_account tool
â”‚   â””â”€â”€ get-permissions.ts
â”œâ”€â”€ chain/
â”‚   â”œâ”€â”€ get-chain-info.ts               # Pattern for get_chain_info tool
â”‚   â””â”€â”€ get-block.ts                    # Pattern for get_block tool
â””â”€â”€ [other categories - ignore for MVP]

MCP Server (for reference only):
/workspaces/XPR/agentic_dev/experiment_01/src/index.ts
```

### Proton CLI (Your Subprocess Executor)
```
/workspaces/XPR/proton-cli/
â”œâ”€â”€ bin/run                             # CLI entry point
â”œâ”€â”€ package.json                        # @proton/cli v0.1.95
â””â”€â”€ src/commands/                       # CLI command implementations
    â”œâ”€â”€ account/index.ts                # account <name>
    â”œâ”€â”€ chain/index.ts                  # chain
    â””â”€â”€ block/index.ts                  # block <block_num>

Test with: proton account zenpunk
           proton chain
           proton block 1
```

### Your Target Directory Structure
```
/workspaces/XPR/agentic_dev/experiment_03/
â”œâ”€â”€ agent.md                            # â† You are here (read first)
â”œâ”€â”€ CHANGES.md                          # â† Track every change here
â”œâ”€â”€ AGENT_PROMPT.md                     # â† This file
â””â”€â”€ mcp-server/                         # â† Copy experiment_02 here
    â”œâ”€â”€ server.py                       # â† Modify to use Proton CLI
    â”œâ”€â”€ host.json                       # â† Keep same
    â”œâ”€â”€ local.settings.json             # â† Keep same
    â”œâ”€â”€ requirements.txt                # â† Keep same (no new deps needed)
    â”œâ”€â”€ infra/
    â”‚   â”œâ”€â”€ main.bicep                  # â† Update resource names
    â”‚   â””â”€â”€ main.parameters.json        # â† Update environment name
    â””â”€â”€ azure.yaml                      # â† Keep same
```

## ğŸ—ï¸ Infrastructure Configuration

### Azure Resources (Reuse 'sama' Resource Group)
```yaml
Target Resource Group: sama
Target Region: East US 2
Environment Name: experiment-03  # Update in main.parameters.json

Resource Naming Pattern (will be auto-generated by Bicep):
- Resource Group: sama (existing)
- Function App: func-xpr-mcp-{unique-suffix}
- Storage Account: st{unique-suffix}
- App Insights: appi-xpr-mcp-{unique-suffix}
- App Service Plan: plan-xpr-mcp-{unique-suffix}
```

### Deployment Commands
```bash
# First time setup
cd /workspaces/XPR/agentic_dev/experiment_03/mcp-server
azd init  # Select Python app, confirm settings
azd up    # Provision + Deploy

# Iterative redeployment (FAST)
azd deploy  # Just redeploy code, skip provisioning

# Local testing
func start  # Test at http://localhost:7071/mcp
```

### Critical Configuration Files to Update

#### `infra/main.parameters.json`
```json
{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "environmentName": {
      "value": "experiment-03"  // â† Change this from experiment_02
    },
    "location": {
      "value": "eastus2"  // â† Ensure this matches
    }
  }
}
```

#### `azure.yaml`
```yaml
name: xpr-mcp-server  # â† Update if needed
metadata:
  template: azd-init@1.9.0
services:
  mcp:
    project: .
    language: py
    host: azurefunctions
```

## ğŸ”§ Implementation Phases

### Phase 0: Setup & Verification âœ… (Documentation complete)
**Status**: Documentation ready, need to copy code

**Checklist**:
- [x] Read agent.md
- [x] Read CHANGES.md  
- [x] Understand hybrid architecture
- [ ] Copy experiment_02 to mcp-server/
- [ ] Verify copied version works locally
- [ ] Document setup in CHANGES.md

**Commands**:
```bash
cd /workspaces/XPR/agentic_dev/experiment_03/

# Copy baseline
cp -r ../experiment_02/mcp-sdk-functions-hosting-python ./mcp-server

# Verify it works
cd mcp-server
func start
# Test: curl http://localhost:7071/mcp
```

### Phase 1: First Tool (get_account)
**Goal**: Remove weather tools, add ONE blockchain tool

**Tasks**:
1. Remove weather tools from server.py (Document in CHANGES.md #005)
2. Add subprocess executor for Proton CLI (Document in CHANGES.md #006)
3. Implement get_account tool (Document in CHANGES.md #007)
4. Test locally (Document in CHANGES.md #008)

**Test Command**:
```bash
proton account zenpunk
# Expected: JSON account data
```

**Reference Implementation**:
See `/workspaces/XPR/agentic_dev/experiment_01/src/tools/account/get-account.ts` for logic

### Phase 2: Second Tool (get_chain_info)
**Goal**: Add chain info query

**Reference**: `/workspaces/XPR/agentic_dev/experiment_01/src/tools/chain/get-chain-info.ts`

### Phase 3: Third Tool (get_block)
**Goal**: Add block query

**Reference**: `/workspaces/XPR/agentic_dev/experiment_01/src/tools/chain/get-block.ts`

### Phase 4: Local Testing
**Goal**: Verify all 3 tools work via FastMCP

### Phase 5: Azure Deployment
**Goal**: Deploy to 'sama' resource group, verify in production

## ğŸ“ Change Tracking Protocol

### Before EVERY Change
1. Open `/workspaces/XPR/agentic_dev/experiment_03/CHANGES.md`
2. Add entry with Change ID, timestamp, description
3. Note which file(s) will be modified

### After EVERY Change
1. Update CHANGES.md with results (success/failure)
2. Include any errors or issues
3. Note any auth configuration changes (CRITICAL)

### Format
```markdown
## Change #XXX - [Brief Description]
**Timestamp**: 2024-12-25 HH:MM UTC
**Files**: path/to/file.py
**Type**: [Added/Modified/Removed]
**Status**: [Planned/In Progress/Complete/Failed]

### What Changed
- Specific change description

### Why
- Rationale

### Testing
- How to verify

### Rollback
- How to undo if needed
```

## ğŸ¯ Success Criteria

### Minimum Viable Product (MVP)
- [ ] 3 tools implemented: get_account, get_chain_info, get_block
- [ ] All tools return correct data from Proton blockchain
- [ ] Deployed to Azure 'sama' resource group
- [ ] MCP endpoint responds at production URL
- [ ] No auth issues (carefully documented)

### Quality Checks
- [ ] Local testing passes: `func start` works
- [ ] Deployment succeeds: `azd up` completes
- [ ] All changes documented in CHANGES.md
- [ ] No errors in Application Insights

## âš ï¸ Critical Warnings

### Authentication Configuration
**CRITICAL**: Experiment_02 had auth disabled and it caused problems. Track EVERY auth change:
```markdown
### Auth Changes (if any)
- File: host.json or main.bicep
- Old Value: "authLevel": "anonymous"
- New Value: "authLevel": "function"
- Reason: [explanation]
- Testing: [how you verified]
```

### Do NOT
- âŒ Implement all 32 tools from experiment_01 (only 3 for MVP)
- âŒ Modify infrastructure without documenting in CHANGES.md
- âŒ Change resource group from 'sama'
- âŒ Skip change tracking
- âŒ Make multiple changes without testing between them

## ğŸš€ Quick Start Command Sequence

```bash
# 1. Navigate to experiment_03
cd /workspaces/XPR/agentic_dev/experiment_03/

# 2. Read documentation
cat agent.md
cat CHANGES.md
cat AGENT_PROMPT.md  # You are here

# 3. Copy baseline
cp -r ../experiment_02/mcp-sdk-functions-hosting-python ./mcp-server

# 4. Document the copy
# Edit CHANGES.md, add Change #003

# 5. Verify baseline works
cd mcp-server
func start
# Test weather tools still work

# 6. Start modifications
# Edit server.py
# Remove weather tools
# Add Proton CLI executor
# Implement get_account

# 7. Test after each change
func start
# Test tool via MCP protocol

# 8. Deploy when ready
azd up  # First time
# OR
azd deploy  # Fast iteration
```

## ğŸ”— Navigation Map

```
START HERE â†’ agent.md (vision & architecture)
              â†“
          CHANGES.md (track every change)
              â†“
          AGENT_PROMPT.md (this file - implementation guide)
              â†“
          Copy experiment_02 â†’ mcp-server/
              â†“
          Modify server.py (remove weather, add blockchain)
              â†“
          Test locally (func start)
              â†“
          Deploy to Azure (azd up)
              â†“
          Verify production URL
```

## ğŸ“š Additional Resources

### Experiment 02 Documentation
```
/workspaces/XPR/agentic_dev/experiment_02/README.md
/workspaces/XPR/agentic_dev/experiment_02/mcp-sdk-functions-hosting-python/README.md
```

### Proton CLI Documentation
```
/workspaces/XPR/proton-cli/README.md
```

### FastMCP Documentation
- GitHub: https://github.com/jlowin/fastmcp
- Examples in experiment_02/server.py

## ğŸ“ Context Engineering Best Practices

### For Maximum Agent Success
1. **Start Small**: Implement ONE tool first, verify it works
2. **Document Everything**: Future you (or another agent) will thank you
3. **Test Incrementally**: After each change, test locally
4. **Use References**: Look at experiment_01 tools for patterns
5. **Copy Working Code**: Experiment_02 works - build on success
6. **Track Auth Changes**: This caused issues before - be meticulous

### File Reading Strategy
```
1. agent.md â†’ Understand the vision
2. CHANGES.md â†’ Understand what will be tracked
3. AGENT_PROMPT.md â†’ Get implementation details (this file)
4. experiment_02/server.py â†’ See working FastMCP server
5. experiment_01/src/tools/account/get-account.ts â†’ See tool pattern
6. proton-cli/README.md â†’ Understand CLI commands
```

### Navigation Shortcuts
```bash
# Working directory
cd /workspaces/XPR/agentic_dev/experiment_03/

# View baseline server
cat ../experiment_02/mcp-sdk-functions-hosting-python/server.py

# View tool pattern
cat ../experiment_01/src/tools/account/get-account.ts

# Test Proton CLI
cd /workspaces/XPR/proton-cli
./bin/run account zenpunk
./bin/run chain
./bin/run block 1

# Deploy
cd /workspaces/XPR/agentic_dev/experiment_03/mcp-server
azd deploy  # Fast iteration
```

## âœ… Pre-Flight Checklist

Before you start coding:
- [ ] Read agent.md completely
- [ ] Read CHANGES.md format
- [ ] Understand the 3-tool MVP scope
- [ ] Know where experiment_02 code is
- [ ] Know where experiment_01 patterns are
- [ ] Know where Proton CLI is
- [ ] Understand 'sama' resource group requirement
- [ ] Understand azd deploy for fast iteration
- [ ] Understand auth issue warning
- [ ] Ready to document every change

## ğŸ¯ Your First Task

**When you start, do this**:
```bash
cd /workspaces/XPR/agentic_dev/experiment_03/
cp -r ../experiment_02/mcp-sdk-functions-hosting-python ./mcp-server
```

Then open `/workspaces/XPR/agentic_dev/experiment_03/CHANGES.md` and add:
```markdown
## Change #003 - Copy Experiment 02 Baseline
**Timestamp**: [current time]
**Files**: All files from experiment_02
**Type**: Added
**Status**: Complete

### What Changed
- Copied entire mcp-sdk-functions-hosting-python directory to mcp-server/
- This provides working Azure Functions + FastMCP baseline

### Why
- Start from known working state (experiment_02 is deployed and functional)
- Minimize risk by modifying incrementally from working code

### Testing
- [ ] Run: cd mcp-server && func start
- [ ] Verify weather tools still work at http://localhost:7071/mcp

### Next Steps
- Verify baseline works locally
- Then proceed to Phase 1: Remove weather tools, add get_account
```

**Then verify it works**:
```bash
cd mcp-server
func start
# You should see the function app running
# Weather tools should still work
```

**If verification succeeds**, update CHANGES.md status to "Complete" and proceed to Phase 1.

---

**Good luck! Remember: Small changes, test often, document everything.**
